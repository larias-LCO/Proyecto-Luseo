<!-- ‚úÖ Coloca tus componentes de encabezado -->
<app-header></app-header>
<app-submenu></app-submenu>

<!-- ‚úÖ Contenedor principal del TEAM -->
<div class="team-container">
  
    <h1>Team</h1>
  

  <!-- Filters form (Reactive) -->
<form [formGroup]="filterForm" class="filters-form" (ngSubmit)="$event.preventDefault()">

  <!-- Buscar por nombre -->
  <div class="filter-search">
    <label>Search by name</label>
  <input id="searchInput" type="text" placeholder="Ej: Carlos, Herrera" formControlName="q" />
    <div class="muted">Partial search, case and accent insensitive. Filters locally.</div>
  </div>

  <!-- Filtros horizontales -->
 <div class="filters-row">
  <div class="filter-item">
    <label>Department</label>
    <select formControlName="department">
      <option value="">All</option>
      <option *ngFor="let d of (catalogs.departments || [])" [value]="(d.name ?? d)">
        {{ d.name ?? d }}
      </option>
    </select>
  </div>

  <div class="filter-item">
    <label>Position</label>
    <select formControlName="job">
      <option value="">All</option>
      <option *ngFor="let j of (catalogs.jobs || [])" [value]="(j.name ?? j)">
        {{ j.name ?? j }}
      </option>
    </select>
  </div>

  <div class="filter-item">
    <label>Office</label>
    <select formControlName="office">
      <option value="">All</option>
      <option *ngFor="let o of (catalogs.offices || [])" [value]="(o.name ?? o)">
        {{ o.name ?? o }}
      </option>
    </select>
  </div>

  <div class="filter-item">
    <label>Role</label>
    <select formControlName="role">
      <option value="">All</option>
      <option *ngFor="let r of roleFilterOptions" [value]="r">{{ r }}</option>
    </select>
  </div>

  <div class="filter-item">
    <label>State</label>
    <select formControlName="state">
      <option value="">All</option>
      <option value="ACTIVE">Active</option>
      <option value="INACTIVE">Inactive</option>
    </select>
  </div>
</div>


  <!--  botones dentro del form -->
  <!-- üîπ Fila inferior: Mostrar por p√°gina + Botones -->
<div class="filters-row bottom-row">
  <div class="filter-item small">
    <label>Show per page</label>
    <select formControlName="size">
      <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
    </select>
  </div>

  <div class="buttons-group">
    <!-- Mostrar bot√≥n Agregar solo a ADMIN y OWNER -->
    <app-fagregar-miembro
      *ngIf="canAddMember"
      [catalogs]="catalogs"
      [allowedRoles]="allowedRoleOptions"
      (created)="refreshData()"
    ></app-fagregar-miembro>
    <button type="button" (click)="refreshData()" [disabled]="loading">Update Data</button>
    <button type="button" (click)="filterForm.reset({ q: '', department: '', job: '', office: '', state: '', role: '', size: pageSizes[0] })">
      Clean filters
    </button>
    
  </div>
</div>

</form>  <!--  ahora el form se cierra correctamente -->

    

    


  <!-- Status / error -->
  <div class="row status-row">
    <span class="muted" *ngIf="!error && !loading">{{ filtered.length }} resultados</span>
    <span class="muted" *ngIf="loading">Cargando empleados...</span>
    <span class="error" *ngIf="error">{{ error }}</span>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table class="team-table" *ngIf="!loading && filtered.length >= 0">
      <thead>
       <tr>
          <th class="col-name">Name</th>
          <th class="col-dept">Department</th>
          <th class="col-office">Office</th>
          <th class="col-pos">Position</th>
          <th class="col-rate text-right">Rate (per hour)</th>
          <th class="col-role text-center">Role</th>
          <th class="col-state text-center">State</th>
          <th class="col-actions text-right">Actions</th>
        </tr>
      </thead>
        <tbody>
        <tr *ngFor="let m of pagedResults">
          <!-- Nombre -->
          <td class="td-name" title="{{ m.name }}">
            {{ (m.name ?? '(Sin nombre)') }}
          </td>

          <!-- Departamento -->
          <td class="td-dept" title="{{ m.departmentName }}">
            {{ m.departmentName ?? '-' }}
          </td>

          <!-- Oficina -->
          <td class="td-office" title="{{ m.officeName }}">
            {{ m.officeName ?? '-' }}
          </td>

          <!-- Posici√≥n -->
          <td class="td-pos" title="{{ m.jobPositionName }}">
            {{ m.jobPositionName ?? '-' }}
          </td>

          <!-- Tarifa (alineada a la derecha, con formato si tienes uno) -->
          <td class="td-rate text-right">
            {{ m.billableRate != null ? (m.billableRate | number:'1.0-2') : '-' }}
          </td>

          <!-- Rol (badge, uppercase) -->
          <td class="td-role text-center">
            <span
              class="role-badge"
              [ngClass]="{
                'role-admin': getEmployeeRoles(m).includes('ADMIN'),
                'role-owner': getEmployeeRoles(m).includes('OWNER'),
                'role-user': getEmployeeRoles(m).includes('USER')
              }">
              {{ (getEmployeeRoles(m)[0] || (m.accountRole ?? (m.roles?.[0] || '-'))) | uppercase }}
            </span>
          </td>

          <!-- Estado (badge, uppercase) -->
          <td class="td-state text-center">
            <span
              class="state-badge"
              [ngClass]="{
                'state-active': (m.state || '') === 'ACTIVE',
                'state-inactive': (m.state || '') === 'INACTIVE'
              }">
              {{ (m.state ?? '-') | uppercase }}
            </span>
          </td>

          <!-- Acciones (alineadas a la derecha) -->
          <td class="td-actions text-right">
            <!-- Ocultar acciones para USER; ADMIN no puede tocar OWNER -->
            <ng-container *ngIf="canEditDelete && !(isAdmin && getEmployeeRoles(m).includes('OWNER')); else noActions">
              <button
                class="btn-action btn-edit"
                (click)="abrirModal(m)"
                [title]="'Editar'"
                aria-label="Edit {{m.name}}"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                class="btn-action btn-delete"
                (click)="eliminarEmpleado(m.id)"
                [title]="'Delete'"
                aria-label="Delete {{m.name}}"
              >
                üóëÔ∏è Delete
              </button>
            </ng-container>
            <ng-template #noActions>
              <span class="muted">‚Äî</span>
            </ng-template>
          </td>
        </tr>

        <tr *ngIf="!pagedResults.length">
          <td colspan="8" class="muted">No hay resultados</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button (click)="setPage(1)" [disabled]="page === 1">¬´</button>
    <button (click)="setPage(page - 1)" [disabled]="page === 1">‚Äπ</button>

    <button *ngFor="let p of [].constructor(totalPages) | slice:0:totalPages; let i = index"
            (click)="setPage(i+1)"
            [class.active]="page === (i+1)">
      {{ i+1 }}
    </button>

    <button (click)="setPage(page + 1)" [disabled]="page === totalPages">‚Ä∫</button>
    <button (click)="setPage(totalPages)" [disabled]="page === totalPages">¬ª</button>
  </div>

  <!-- Modal editar -->
  <app-editar-miembro
    *ngIf="mostrarModal"
    [miembro]="miembroSeleccionado"
    [catalogs]="catalogs"
    [allowedRoles]="allowedRoleOptions"
    (cerrar)="cerrarModal()"
    (guardar)="guardarCambios($event)">
  </app-editar-miembro>
</div>