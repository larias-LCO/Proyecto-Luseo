<!-- ‚úÖ Coloca tus componentes de encabezado -->
<app-header></app-header>
<app-submenu class="menu" [class.open]="isMenuOpen$ | async" ></app-submenu>

<app-menu-filters-team
  [departments]="catalogs?.departments ?? []"
  [positions]="catalogs?.jobs ?? []"
  [offices]="catalogs?.offices ?? []"
  [roles]="roleFilterOptions"
  [states]="stateOptions"
  (filtersChange)="onFiltersChange($event)"
  (toggleSubmenu)="isMenuOpen = !isMenuOpen"></app-menu-filters-team>


<!-- ‚úÖ Contenedor principal del TEAM -->
<div class="team-container">
  
    <h1>Team</h1>
  

  <!-- Filters form (Reactive)
<form [formGroup]="filterForm" class="filters-form" (ngSubmit)="$event.preventDefault()"> -->

  <!-- Buscar por nombre -->
  <!-- <div class="filter-search">
    <label>Search by name</label>
  <input id="searchInput" type="text" placeholder="Ej: Carlos, Herrera" formControlName="q" />
    <div class="muted">Partial search, case and accent insensitive. Filters locally.</div>
  </div> -->

  <!-- Filtros horizontales
 <div class="filters-row">
  <div class="filter-item">
    <label>Department</label>
    <select formControlName="department">
      <option value="">All</option>
      <option *ngFor="let d of (catalogs.departments || [])" [value]="(d.name ?? d)">
        {{ d.name ?? d }}
      </option>
    </select>
  </div> -->

  <!-- <div class="filter-item">
    <label>Position</label>
    <select formControlName="job">
      <option value="">All</option>
      <option *ngFor="let j of (catalogs.jobs || [])" [value]="(j.name ?? j)">
        {{ j.name ?? j }}
      </option>
    </select>
  </div> -->

  <!-- <div class="filter-item">
    <label>Office</label>
    <select formControlName="office">
      <option value="">All</option>
      <option *ngFor="let o of (catalogs.offices || [])" [value]="(o.name ?? o)">
        {{ o.name ?? o }}
      </option>
    </select>
  </div> -->

  <!-- <div class="filter-item">
    <label>Role</label>
    <select formControlName="role">
      <option value="">All</option>
      <option *ngFor="let r of roleFilterOptions" [value]="r">{{ r }}</option>
    </select>
  </div> -->

  <!-- <div class="filter-item">
    <label>State</label>
    <select formControlName="state">
      <option value="">All</option>
      <option value="ACTIVE">Active</option>
      <option value="INACTIVE">Inactive</option>
    </select>
  </div>
</div> -->


  <!--  botones dentro del form -->
  <!-- üîπ Fila inferior: Mostrar por p√°gina + Botones -->
<div class="filters-row bottom-row">
  <div class="filter-item small">
    <label>Show per page</label>
    <select formControlName="size">
      <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
    </select>
  </div>

  <div class="buttons-group">
    <!-- Mostrar bot√≥n Agregar solo a ADMIN y OWNER -->
    <app-fagregar-miembro
      *ngIf="canAddMember"
      [catalogs]="catalogs"
      [allowedRoles]="allowedRoleOptions"
      (created)="refreshData()"
    ></app-fagregar-miembro>



    <button type="button" (click)="refreshData()" [disabled]="loading">Update Data</button>
    <button type="button" (click)="filterForm.reset({ q: '', department: '', job: '', office: '', state: '', role: '', size: pageSizes[0] })">
      Clean filters
    </button>
    
  </div>
</div>



<!-- </form>   ahora el form se cierra correctamente -->

  
  <!-- Status / error -->
  <div class="row status-row">
    <span class="muted" *ngIf="!error && !loading">{{ filtered.length }} resultados</span>
    <span class="muted" *ngIf="loading">Cargando empleados...</span>
    <span class="error" *ngIf="error">{{ error }}</span>
  </div>

  

<!-- Cards grid -->
<div class="cards-grid" *ngIf="!loading">

  <div class="employee-card" *ngFor="let m of pagedResults">

    <!-- Header -->
    <div class="card-header">
      <div class="avatar">
        {{ getInitials(m.name) }}
      </div>

      <div class="user-info">
        <div class="name" title="{{ m.name }}">
          {{ m.name || '(Sin nombre)' }}
        </div>
        <div class="position">
          {{ m.jobPositionName || '-' }}
        </div>
      </div>

      <span
        class="state-badge"
        [ngClass]="{
          'state-active': m.state === 'ACTIVE',
          'state-inactive': m.state === 'INACTIVE'
        }">
        {{ m.state }}
      </span>
    </div>

    <!-- Body -->
    <div class="card-body">
      <div class="info-row">
        <span>Department</span>
        <strong>{{ m.departmentName || '-' }}</strong>
      </div>

      <div class="info-row">
        <span>Office</span>
        <strong>{{ m.officeName || '-' }}</strong>
      </div>

      <div class="info-row">
        <span>Billable Rate</span>
        <strong>
          {{ m.billableRate != null ? ('$' + (m.billableRate | number:'1.0-2')) : '-' }}
        </strong>
      </div>

      <span
        class="role-badge"
        [ngClass]="{
          'role-admin': getEmployeeRoles(m).includes('ADMIN'),
          'role-owner': getEmployeeRoles(m).includes('OWNER'),
          'role-user': getEmployeeRoles(m).includes('USER')
        }">
        {{ getEmployeeRoles(m)[0] }}
      </span>
    </div>

    <!-- Actions -->
    <div class="card-actions" *ngIf="canEditDelete">
      <ng-container *ngIf="!(isAdmin && getEmployeeRoles(m).includes('OWNER')); else noActions">
        <button class="btn-edit" (click)="abrirModal(m)">‚úèÔ∏è Edit</button>
        <button class="btn-delete" (click)="eliminarEmpleado(m.id)">üóëÔ∏è Delete</button>
      </ng-container>

      <ng-template #noActions>
        <span class="muted">‚Äî</span>
      </ng-template>
    </div>

  </div>

  <!-- Empty -->
  <div class="empty" *ngIf="!pagedResults.length">
    No hay resultados
  </div>

</div>


  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button (click)="setPage(1)" [disabled]="page === 1">¬´</button>
    <button (click)="setPage(page - 1)" [disabled]="page === 1">‚Äπ</button>

    <button *ngFor="let p of [].constructor(totalPages) | slice:0:totalPages; let i = index"
            (click)="setPage(i+1)"
            [class.active]="page === (i+1)">
      {{ i+1 }}
    </button>

    <button (click)="setPage(page + 1)" [disabled]="page === totalPages">‚Ä∫</button>
    <button (click)="setPage(totalPages)" [disabled]="page === totalPages">¬ª</button>
  </div>

  <!-- Modal de confirmaci√≥n reutilizable -->
  <app-confirm-modal
    *ngIf="confirmDeleteId"
    [message]="'¬øEliminar empleado ' + confirmDeleteName + '? Esta acci√≥n no se puede deshacer.'"
    [confirmText]="'Aceptar'"
    [cancelText]="'Cancelar'"
    (confirm)="confirmarEliminarEmpleado()"
    (cancel)="cancelarEliminarEmpleado()"
  ></app-confirm-modal>

  <!-- Modal editar -->
  <app-editar-miembro
    *ngIf="mostrarModal"
    [miembro]="miembroSeleccionado"
    [catalogs]="catalogs"
    [allowedRoles]="allowedRoleOptions"
    (cerrar)="cerrarModal()"
    (guardar)="guardarCambios($event)">
  </app-editar-miembro>
</div>
